<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat with {{ partner.username }} - FreeConnect</title>
    <link rel="stylesheet" href="/static/chat.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    {{ moment.include_moment() }}
</head>
<body>
    <!-- Chat Navbar -->
    <div class="chat-navbar">
        <a href="{{ url_for('home') }}">‚Üê Back</a>
        <h2>Chat with {{ partner.username }}</h2>
    </div>

    <!-- Notification Bar -->
    <div id="notification-bar" class="notification-bar" style="display: none;">
        <p id="notification-message"></p>
    </div>

    <!-- Chat Messages -->
    <div class="chat-container" id="chat-box">
        {% for message in messages %}
            <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                <p>{{ message.content }}</p>
                <small>{{ moment(message.timestamp).fromNow() }}</small>
            </div>
        {% endfor %}
    </div>

    <!-- Typing Indicator -->
    <div id="typing-indicator" style="display: none; font-style: italic; color: gray;">
        {{ partner.username }} is typing...
    </div>

    <!-- Message Input Form -->
    <form id="message-form">
        <input type="text" id="message-input" placeholder="Type your message..." required autocomplete="off">
        <button type="submit">Send</button>
    </form>

    <script>
        const socket = io();
        const chatBox = document.getElementById('chat-box');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const typingIndicator = document.getElementById('typing-indicator'); // Typing indicator element
        const notificationBar = document.getElementById('notification-bar'); // Notification bar element
        const notificationMessage = document.getElementById('notification-message'); // Notification text

        let typingTimeout;

        // When the user starts typing, emit a typing event
        messageInput.addEventListener('input', () => {
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Emit typing event to the server
            socket.emit('typing', {
                receiver_id: {{ partner.id }}
            });

            // Stop typing event after 3 seconds of inactivity
            typingTimeout = setTimeout(() => {
                socket.emit('typing', {
                    receiver_id: {{ partner.id }}
                });
            }, 3000);
        });

        // Listen for 'new_message' event from the server and display the message
        socket.on('new_message', data => {
            if (data.sender_id !== {{ current_user.id }} && data.sender_id === {{ partner.id }}) {
                const msg = document.createElement('div');
                msg.classList.add('message', 'received');
                msg.innerHTML = `<p>${data.content}</p><small>${data.timestamp}</small>`;
                chatBox.appendChild(msg);
                chatBox.scrollTop = chatBox.scrollHeight;

                // Display a notification to the user when a new message arrives
                notificationMessage.textContent = `New message from ${data.sender_id === {{ partner.id }} ? '{{ partner.username }}' : 'You'}`;
                notificationBar.style.display = 'block';
                setTimeout(() => {
                    notificationBar.style.display = 'none';
                }, 5000);

                // Send push notification if subscription is available
                if ('Notification' in window && Notification.permission === 'granted') {
                    // Make sure the user has granted permission for notifications
                    sendPushNotification(data);
                }
            }
        });

        // Listen for 'typing' event to show typing indicator
        socket.on('typing', data => {
            if (data.sender_id === {{ partner.id }} && data.receiver_id === {{ current_user.id }}) {
                typingIndicator.style.display = 'block';  // Show typing indicator
            } else {
                typingIndicator.style.display = 'none'; // Hide if not the correct partner
            }
        });

        // Hide typing indicator after message is sent or after timeout
        messageForm.addEventListener('submit', e => {
            e.preventDefault();
            const content = messageInput.value;

            if (content.trim() !== '') {
                socket.emit('message', {
                    receiver_id: {{ partner.id }},
                    content: content
                });

                const msg = document.createElement('div');
                msg.classList.add('message', 'sent');
                const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                msg.innerHTML = `<p>${content}</p><small>${now}</small>`;
                chatBox.appendChild(msg);
                chatBox.scrollTop = chatBox.scrollHeight;
                messageInput.value = '';

                // Hide typing indicator when the message is sent
                typingIndicator.style.display = 'none';
            }
        });

        // Function to send push notification to the client
        function sendPushNotification(data) {
            const subscriptionInfo = {/* Retrieve subscription info from service worker */};

            fetch('/send_push_notification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subscription_info: subscriptionInfo,
                    message: data.content
                })
            })
            .then(response => response.json())
            .then(data => console.log('Push notification sent', data))
            .catch(error => console.error('Error sending push notification', error));
        }
    </script>
</body>
</html>
